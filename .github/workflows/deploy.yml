name: Build & Deploy App
on:
    push:
        branches: [NewClient] # run on pushes to master
jobs:
    build-and-test:
        runs-on: ubuntu-latest
        steps:
            - name: Generate build number
              uses: einaregilsson/build-number@v3
              with:
                  token: ${{secrets.github_token}}
            - name: Print new build number
              run: echo "Build number is $BUILD_NUMBER"
            - uses: actions/checkout@v2 # setup the repository in the runner
            - name: Setup Node.js # setup Node.js in the runner
              uses: actions/setup-node@v1
              with:
                  node-version: '12'
            - uses: actions/cache@v2
              with:
                  path: ~/.npm
                  key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
                  restore-keys: ${{ runner.os }}-node-
            - name: Declare some variables
              id: vars
              shell: bash
              run: |
                  echo "##[set-output name=branch;]$(echo ${GITHUB_REF#refs/heads/})"
                  echo "::set-output name=sha_short::$(git rev-parse --short HEAD)"
            - run: npm ci # install dependencies
              env:
                  VITE_BUILD_VERSION: ${{ github.sha }}
            - run: VITE_BUILD_VERSION=${{steps.vars.outputs.sha_short }} VITE_BUILD_NUMBER=$BUILD_NUMBER npm run build:mock --if-present # build the project
            - run: npm run test -- --coverage # run the tests
            - name: Upload coverage to Codecov
              uses: codecov/codecov-action@v1
              with:
                  token: ${{ secrets.CODECOV_TOKEN }}
            # deploy site to netlify using secrets created on repository
            - uses: netlify/actions/cli@master
              env:
                  NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
                  NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
                  VITE_BUILD_VERSION: ${{ github.sha }}
              with:
                  args: deploy --dir=dist --prod
